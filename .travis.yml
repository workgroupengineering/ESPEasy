language: python
python:
  - '2.7'

#we want a newer cppcheck, so use trusty
dist: trusty

sudo: false

cache:
  directories:
  - "~/.platformio"
  - "./.pioenvs"



addons:
  apt:
    packages:
    - cppcheck



install:
  - pip install -U platformio

script:
  # - cppcheck --enable=warning src/*.ino -q --force -I src --include=src/ESPEasy.ino --error-exitcode=1
  # - ./memanalyzer.py ~/.platformio/packages/toolchain-xtensa/bin/xtensa-lx106-elf-objdump
  - PLATFORMIO_BUILD_FLAGS="-D CONTINUOUS_INTEGRATION" platformio run 

  # patch platformio core libs for PUYA bug (https://github.com/letscontrolit/ESPEasy/issues/650)
  #- cd patches; ./check_puya_patch; cd ..
  #- PLATFORMIO_BUILD_FLAGS="-D CONTINUOUS_INTEGRATION" platformio run -s --environment dev_ESP8266PUYA_1024


before_deploy:
  - ./before_deploy
  - export RELEASE_FILE=$(ls ESPEasy*.zip)

deploy:
  provider: releases
  prerelease: true
  api_key:
    secure: $APIKEY
  file_glob: true
  file: "${RELEASE_FILE}"

  skip_cleanup: true
  on:
      tags: true
      repo: $REPOSITORY

notifications:
  email: false

# Only build tags
if: tag IS present